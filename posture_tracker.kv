#:kivy 2.3.0
#:import dp kivy.metrics.dp
#:import sp kivy.metrics.sp
#:import Window kivy.core.window.Window

# ── Modern Dark Theme Color Definitions ──
# Background:  (0.12, 0.12, 0.14, 1) — near-black
# Surface:     (0.17, 0.17, 0.20, 1) — card background
# Accent:      (0.25, 0.56, 1.0, 1)  — bright blue
# Good:        (0.18, 0.80, 0.44, 1) — green
# Bad:         (0.91, 0.30, 0.24, 1) — red
# Text:        (0.93, 0.93, 0.95, 1) — near-white
# Text Muted:  (0.55, 0.55, 0.60, 1) — muted

# ── Reusable Card Widget ──
<Card@BoxLayout>:
    canvas.before:
        Color:
            rgba: 0.17, 0.17, 0.20, 1
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [dp(12)]

# ── Reusable Modern Button ──
<ModernButton@Button>:
    background_normal: ''
    background_down: ''
    background_color: 0, 0, 0, 0
    color: 0.93, 0.93, 0.95, 1
    font_size: sp(16)
    bold: True
    size_hint_y: None
    height: dp(48)
    canvas.before:
        Color:
            rgba: self.theme_color if not self.disabled else (0.28, 0.28, 0.32, 1)
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [dp(10)]
    theme_color: 0.25, 0.56, 1.0, 1

# ── Reusable Accent Button (green) ──
<AccentButton@ModernButton>:
    theme_color: 0.18, 0.80, 0.44, 1

# ── Reusable Danger Button (red) ──
<DangerButton@ModernButton>:
    theme_color: 0.91, 0.30, 0.24, 1

# ── Modern Spinner ──
<ModernSpinner@Spinner>:
    background_normal: ''
    background_down: ''
    background_color: 0, 0, 0, 0
    color: 0.93, 0.93, 0.95, 1
    font_size: sp(15)
    size_hint_y: None
    height: dp(44)
    canvas.before:
        Color:
            rgba: 0.22, 0.22, 0.26, 1
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [dp(8)]

# ── Modern Text Input ──
<ModernTextInput@TextInput>:
    background_normal: ''
    background_active: ''
    background_color: 0.22, 0.22, 0.26, 1
    foreground_color: 0.93, 0.93, 0.95, 1
    cursor_color: 0.25, 0.56, 1.0, 1
    font_size: sp(16)
    padding: [dp(12), dp(10)]
    size_hint_y: None
    height: dp(44)

<PostureTrackerApp>:
    do_default_tab: False
    tab_pos: 'top_mid'
    tab_width: dp(160)
    tab_height: dp(44)
    background_color: 0.12, 0.12, 0.14, 1
    # Dark background for entire panel
    canvas.before:
        Color:
            rgba: 0.12, 0.12, 0.14, 1
        Rectangle:
            pos: self.pos
            size: self.size
    # Tab strip styling
    strip_border: [0, 0, 0, 0]

    TabbedPanelItem:
        text: 'Camera'
        background_normal: ''
        background_down: ''
        background_color: 0.22, 0.22, 0.26, 1
        color: 0.93, 0.93, 0.95, 1

        BoxLayout:
            orientation: 'vertical'
            padding: dp(16)
            spacing: dp(12)
            canvas.before:
                Color:
                    rgba: 0.12, 0.12, 0.14, 1
                Rectangle:
                    pos: self.pos
                    size: self.size

            # ── Camera Selection Card ──
            Card:
                size_hint_y: None
                height: dp(56)
                orientation: 'horizontal'
                padding: [dp(14), dp(6)]
                spacing: dp(10)

                Label:
                    text: 'Camera:'
                    size_hint_x: 0.25
                    font_size: sp(15)
                    color: 0.55, 0.55, 0.60, 1
                    halign: 'left'
                    valign: 'middle'
                    text_size: self.size

                ModernSpinner:
                    id: camera_spinner
                    text: 'Detecting cameras...'
                    size_hint_x: 0.75
                    values: ['Detecting cameras...']

            # ── Video Display Card ──
            Card:
                orientation: 'vertical'
                padding: dp(8)
                spacing: dp(8)

                Image:
                    id: camera_display
                    allow_stretch: True
                    keep_ratio: True

                # Status bar inside video card
                BoxLayout:
                    size_hint_y: None
                    height: dp(40)
                    orientation: 'horizontal'
                    spacing: dp(10)
                    padding: [dp(8), 0]

                    Label:
                        text: 'Tilt:'
                        size_hint_x: 0.15
                        font_size: sp(15)
                        color: 0.55, 0.55, 0.60, 1
                        halign: 'right'
                        valign: 'middle'
                        text_size: self.size

                    Label:
                        id: tilt_label
                        text: '0.0°'
                        size_hint_x: 0.25
                        font_size: sp(22)
                        bold: True
                        color: 0.55, 0.55, 0.60, 1
                        halign: 'left'
                        valign: 'middle'
                        text_size: self.size

                    Label:
                        id: status_label
                        text: 'Ready'
                        size_hint_x: 0.6
                        font_size: sp(16)
                        bold: True
                        color: 0.55, 0.55, 0.60, 1
                        halign: 'right'
                        valign: 'middle'
                        text_size: self.size

            # ── Control Buttons ──
            BoxLayout:
                size_hint_y: None
                height: dp(52)
                orientation: 'horizontal'
                spacing: dp(12)

                AccentButton:
                    id: start_button
                    text: 'Start Tracking'
                    on_press: app.start_tracking()
                    disabled: False

                DangerButton:
                    id: stop_button
                    text: 'Stop Tracking'
                    on_press: app.stop_tracking()
                    disabled: True

    TabbedPanelItem:
        text: 'Training'
        background_normal: ''
        background_down: ''
        background_color: 0.22, 0.22, 0.26, 1
        color: 0.93, 0.93, 0.95, 1

        BoxLayout:
            orientation: 'vertical'
            padding: dp(16)
            spacing: dp(12)
            canvas.before:
                Color:
                    rgba: 0.12, 0.12, 0.14, 1
                Rectangle:
                    pos: self.pos
                    size: self.size

            # ── Header with Exercise Selection ──
            BoxLayout:
                orientation: 'horizontal'
                spacing: dp(12)
                size_hint_y: None
                height: dp(60)

                Card:
                    orientation: 'horizontal'
                    padding: [dp(14), dp(8)]
                    spacing: dp(10)
                    size_hint_x: 0.6

                    Label:
                        text: 'Exercise:'
                        size_hint_x: 0.3
                        font_size: sp(15)
                        color: 0.55, 0.55, 0.60, 1
                        halign: 'left'
                        valign: 'middle'
                        text_size: self.size

                    ModernSpinner:
                        id: exercise_spinner
                        text: 'Select Exercise'
                        size_hint_x: 0.7
                        values: ['Select Exercise']
                        on_text: app.select_exercise(self.text)

                Card:
                    orientation: 'horizontal'
                    padding: [dp(14), dp(8)]
                    spacing: dp(10)
                    size_hint_x: 0.4

                    Label:
                        text: 'Category:'
                        size_hint_x: 0.35
                        font_size: sp(15)
                        color: 0.55, 0.55, 0.60, 1
                        halign: 'left'
                        valign: 'middle'
                        text_size: self.size

                    ModernSpinner:
                        id: category_filter_spinner
                        text: 'All'
                        size_hint_x: 0.65
                        values: ['All']
                        on_text: app.filter_exercises_by_category(self.text)

            # ── Split View: Exercise Video + Info ──
            BoxLayout:
                orientation: 'horizontal'
                spacing: dp(12)

                # ── Left: Video Display ──
                Card:
                    orientation: 'vertical'
                    padding: dp(8)
                    spacing: dp(8)
                    size_hint_x: 0.6

                    Image:
                        id: training_camera_display
                        allow_stretch: True
                        keep_ratio: True

                    # Exercise Status Bar
                    BoxLayout:
                        size_hint_y: None
                        height: dp(50)
                        orientation: 'horizontal'
                        spacing: dp(10)
                        padding: [dp(8), dp(4)]

                        Label:
                            text: 'Reps:'
                            size_hint_x: 0.2
                            font_size: sp(14)
                            color: 0.55, 0.55, 0.60, 1
                            halign: 'right'
                            valign: 'middle'
                            text_size: self.size

                        Label:
                            id: training_reps_label
                            text: '0'
                            size_hint_x: 0.15
                            font_size: sp(24)
                            bold: True
                            color: 0.18, 0.80, 0.44, 1
                            halign: 'left'
                            valign: 'middle'
                            text_size: self.size

                        Label:
                            id: training_feedback_label
                            text: 'Select an exercise to begin'
                            size_hint_x: 0.65
                            font_size: sp(13)
                            color: 0.55, 0.55, 0.60, 1
                            halign: 'right'
                            valign: 'middle'
                            text_size: self.size

                    # Control Buttons
                    BoxLayout:
                        size_hint_y: None
                        height: dp(48)
                        orientation: 'horizontal'
                        spacing: dp(10)

                        AccentButton:
                            id: training_start_button
                            text: 'Start Exercise'
                            on_press: app.start_training()
                            disabled: False

                        DangerButton:
                            id: training_stop_button
                            text: 'Stop Exercise'
                            on_press: app.stop_training()
                            disabled: True

                        ModernButton:
                            id: training_reset_button
                            text: 'Reset'
                            on_press: app.reset_training()
                            disabled: False

                # ── Right: Exercise Info & Workout List ──
                BoxLayout:
                    orientation: 'vertical'
                    spacing: dp(12)
                    size_hint_x: 0.4

                    # Exercise Info Card
                    Card:
                        orientation: 'vertical'
                        padding: dp(12)
                        spacing: dp(8)
                        size_hint_y: 0.5

                        Label:
                            text: 'Exercise Details'
                            font_size: sp(16)
                            bold: True
                            color: 0.93, 0.93, 0.95, 1
                            size_hint_y: None
                            height: dp(24)
                            halign: 'left'
                            valign: 'top'
                            text_size: self.size

                        ScrollView:
                            do_scroll_x: False
                            do_scroll_y: True
                            bar_color: 0.35, 0.35, 0.40, 1
                            bar_width: dp(4)

                            Label:
                                id: exercise_info_label
                                text: 'Select an exercise to see details'
                                size_hint_y: None
                                height: self.texture_size[1]
                                font_size: sp(13)
                                color: 0.75, 0.75, 0.80, 1
                                halign: 'left'
                                valign: 'top'
                                text_size: self.width, None
                                markup: True

                    # Current Workout Card
                    Card:
                        orientation: 'vertical'
                        padding: dp(12)
                        spacing: dp(8)
                        size_hint_y: 0.5

                        BoxLayout:
                            orientation: 'horizontal'
                            size_hint_y: None
                            height: dp(32)
                            spacing: dp(8)

                            Label:
                                text: 'Current Workout'
                                font_size: sp(16)
                                bold: True
                                color: 0.93, 0.93, 0.95, 1
                                size_hint_x: 0.6
                                halign: 'left'
                                valign: 'middle'
                                text_size: self.size

                            Button:
                                text: '+'
                                size_hint_x: 0.2
                                size_hint_y: None
                                height: dp(32)
                                font_size: sp(18)
                                bold: True
                                background_normal: ''
                                background_color: 0.18, 0.80, 0.44, 1
                                on_press: app.add_current_exercise_to_workout()

                            Button:
                                text: 'Clear'
                                size_hint_x: 0.2
                                size_hint_y: None
                                height: dp(32)
                                font_size: sp(12)
                                background_normal: ''
                                background_color: 0.91, 0.30, 0.24, 1
                                on_press: app.clear_workout()

                        ScrollView:
                            do_scroll_x: False
                            do_scroll_y: True
                            bar_color: 0.35, 0.35, 0.40, 1
                            bar_width: dp(4)

                            GridLayout:
                                id: workout_list_container
                                cols: 1
                                spacing: dp(6)
                                size_hint_y: None
                                height: self.minimum_height
                                padding: [0, dp(4)]

                        Label:
                            id: workout_status_label
                            text: ''
                            size_hint_y: None
                            height: dp(20)
                            font_size: sp(12)
                            color: 0.55, 0.55, 0.60, 1
                            halign: 'center'
                            valign: 'middle'

    TabbedPanelItem:
        text: 'Settings'
        background_normal: ''
        background_down: ''
        background_color: 0.22, 0.22, 0.26, 1
        color: 0.93, 0.93, 0.95, 1

        BoxLayout:
            orientation: 'vertical'
            padding: dp(16)
            spacing: dp(14)
            canvas.before:
                Color:
                    rgba: 0.12, 0.12, 0.14, 1
                Rectangle:
                    pos: self.pos
                    size: self.size

            # ── Page Title ──
            Label:
                text: 'Settings'
                font_size: sp(22)
                size_hint_y: None
                height: dp(36)
                bold: True
                color: 0.93, 0.93, 0.95, 1
                halign: 'left'
                valign: 'middle'
                text_size: self.size

            # ── Threshold Card ──
            Card:
                orientation: 'vertical'
                spacing: dp(10)
                padding: dp(16)
                size_hint_y: None
                height: dp(170)

                Label:
                    text: 'Tilt Threshold'
                    font_size: sp(17)
                    bold: True
                    color: 0.93, 0.93, 0.95, 1
                    size_hint_y: None
                    height: dp(28)
                    halign: 'left'
                    valign: 'middle'
                    text_size: self.size

                BoxLayout:
                    orientation: 'horizontal'
                    spacing: dp(12)
                    size_hint_y: None
                    height: dp(44)

                    Label:
                        text: 'Degrees:'
                        size_hint_x: 0.35
                        font_size: sp(15)
                        color: 0.55, 0.55, 0.60, 1
                        halign: 'left'
                        valign: 'middle'
                        text_size: self.size

                    ModernTextInput:
                        id: threshold_input
                        text: '15.0'
                        multiline: False
                        input_filter: 'float'
                        size_hint_x: 0.65

                Label:
                    text: 'Lower values = stricter monitoring · Higher values = more lenient\nRecommended: 10–20 degrees'
                    size_hint_y: None
                    height: dp(48)
                    font_size: sp(13)
                    color: 0.45, 0.45, 0.50, 1
                    halign: 'left'
                    valign: 'top'
                    text_size: self.size

            # ── Theme Card ──
            Card:
                orientation: 'vertical'
                spacing: dp(10)
                padding: dp(16)
                size_hint_y: None
                height: dp(130)

                Label:
                    text: 'Appearance'
                    font_size: sp(17)
                    bold: True
                    color: 0.93, 0.93, 0.95, 1
                    size_hint_y: None
                    height: dp(28)
                    halign: 'left'
                    valign: 'middle'
                    text_size: self.size

                BoxLayout:
                    orientation: 'horizontal'
                    spacing: dp(12)
                    size_hint_y: None
                    height: dp(44)

                    Label:
                        text: 'Theme:'
                        size_hint_x: 0.35
                        font_size: sp(15)
                        color: 0.55, 0.55, 0.60, 1
                        halign: 'left'
                        valign: 'middle'
                        text_size: self.size

                    ModernSpinner:
                        id: theme_spinner
                        text: 'Dark'
                        values: ['Dark', 'Light']
                        size_hint_x: 0.65
                        on_text: app.change_theme(self.text)

                Label:
                    text: 'Change the appearance of the application'
                    size_hint_y: None
                    height: dp(24)
                    font_size: sp(13)
                    color: 0.45, 0.45, 0.50, 1
                    halign: 'left'
                    valign: 'top'
                    text_size: self.size

            # ── Camera Management Card ──
            Card:
                orientation: 'vertical'
                spacing: dp(10)
                padding: dp(16)

                Label:
                    text: 'Camera Management'
                    font_size: sp(17)
                    bold: True
                    color: 0.93, 0.93, 0.95, 1
                    size_hint_y: None
                    height: dp(28)
                    halign: 'left'
                    valign: 'middle'
                    text_size: self.size

                BoxLayout:
                    orientation: 'horizontal'
                    spacing: dp(10)
                    size_hint_y: None
                    height: dp(48)

                    ModernButton:
                        text: 'Refresh Cameras'
                        on_press: app.refresh_camera_list()
                        size_hint_x: 0.45

                    Label:
                        id: camera_scan_status
                        text: ''
                        font_size: sp(13)
                        size_hint_x: 0.55
                        color: 0.55, 0.55, 0.60, 1
                        halign: 'left'
                        valign: 'middle'
                        text_size: self.size

                ScrollView:
                    do_scroll_x: False
                    do_scroll_y: True
                    bar_color: 0.35, 0.35, 0.40, 1
                    bar_inactive_color: 0.25, 0.25, 0.28, 0.5
                    bar_width: dp(4)

                    GridLayout:
                        id: camera_list_container
                        cols: 1
                        spacing: dp(6)
                        size_hint_y: None
                        height: self.minimum_height
                        padding: [0, dp(4)]

            # ── Save Button ──
            ModernButton:
                text: 'Save Settings'
                font_size: sp(17)
                on_press: app.save_settings()

            Label:
                id: settings_status
                text: ''
                font_size: sp(14)
                size_hint_y: None
                height: dp(24)
                color: 0.18, 0.80, 0.44, 1
